
var dashboardServices=angular.module("dashBoardServicesModule",[]);dashboardServices.run(["dashboardFactory","$state","$stateParams","$http","$q","$rootScope","$timeout",function(f,d,e,g,b,a,c){a.toolTipOn=true;if(sessionStorage.logged==undefined){f.logout()}a.$on("$stateChangeSuccess",function(m,i,k,o,j){var l=$(document).height();var n=i.name.split(".")[1];if(n=="data"){var l=$(window).height();$(".footer").css("top",l+"px");console.log($(document).height()+":"+$(".footer").css("top"))}else{$(".footer").css("top","initial")}});a.idleTime=0;a.$on("$stateChangeSuccess",function(i,o,q,j,n){if(o.data.secured){if(o.data.secured==true){if(localStorage.userDefs==null||localStorage.userDefs==0||!localStorage.userDefs||localStorage.userDefs==undefined){if(d.current.name!=="/"){d.transitionTo("/")}}else{clearInterval(a.idleInterval);a.idleInterval=setInterval(h,60000);function h(){a.idleTime=a.idleTime+1}if(a.idleTime>20){if(d.current.name!=="/"){alert("It seems that you were inactive for the past 30 minutes or more.\n For security reasons, please login again.");f.logout()}}else{a.idleTime=0}}}}var p=o.name.split(".");if(p[0]==="dashboard"){if(!localStorage.userDefs){d.go("/")}else{var l=JSON.parse(localStorage.userDefs);a.ls=l;a.username=l.username;a.userId=l.id;a.userPositions=JSON.parse(localStorage.uP);a.watchlist=localStorage.watchlist;a.sH=localStorage.searchHistory;a.optionsWatch=JSON.parse(localStorage.optionsWatch);a.clickHistory=JSON.parse(localStorage.cH);if(a.sH==undefined||a.sH==null||a.sH=="null"){a.searchHistory=null}else{var m=a.sH.split(",");var k=[];angular.forEach(m,function(r){if(r.length>0){k.push({q:r})}});a.searchHistory=k}}}})}]);dashboardServices.factory("dashboardFactory",["$log","$http","$q","$state","$rootScope","$timeout",function(e,f,b,d,a,c){return{loginUser:function(i,g){var h={username:i,password:g};f.post("app/php/dashboardApi.php",{act:"userLogin",data:h}).success(function(k){sessionStorage.logged="userLogged";if(k=="NO_USER"){$("#warning").text("Sorry, there is no such user.");$(".usr").val("");$(".pwd").val("")}else{if(k=="WRONG_PWD"){$("#warning").text("Sorry, the password is incorrect.");$(".pwd").val("")}else{if(k=="BLOCKED"){$("#warning").text("You were blocked out of the system.")}else{$("#warning").text("");localStorage.setItem("userDefs",JSON.stringify(k));localStorage.setItem("tracker",k.clickHistory);var j=JSON.parse(localStorage.userDefs);a.ls=j;a.username=j.username;a.userId=j.id;localStorage.watchlist=j.watchlist;a.watchlist=j.watchlist;localStorage.cH=j.clickHistory;a.clickHistory=JSON.parse(localStorage.cH);localStorage.searchHistory=j.searchHistory;a.searchHistory=j.searchHistory;localStorage.uP=j.positions;a.userPositions=JSON.parse(localStorage.uP);localStorage.optionsWatch=j.optionsWatch;a.optionsWatch=JSON.parse(localStorage.optionsWatch);c(function(){d.go("dashboard")},300)}}}})},logout:function(){a.idleTime=0;d.transitionTo("/");localStorage.removeItem("userDefs");localStorage.removeItem("searchHistory");localStorage.removeItem("uP");localStorage.removeItem("watchlist");localStorage.removeItem("optionsWatch");localStorage.removeItem("cH");localStorage.removeItem("tracker");delete a.ls},searchHistory:function(i){var h=b.defer();var g={id:i};f.post("app/php/dashboardApi.php",{act:"getHistory",data:g}).success(function(j){return h.resolve(j)});return h.promise},getStocks:function(h){var g={symbol:h};f.post("app/php/dashboardApi.php",{act:"getStocks",data:g}).success(function(i){})},allStocks:function(){var g=b.defer();f.get("universe.json").success(function(h){return g.resolve(h)});return g.promise},searchStock:function(i,k){var j=b.defer();i=i.toLowerCase();if(a.ls.searchHistory!==null&&a.ls.searchHistory!==""){var g=a.ls.searchHistory.toLowerCase()}$.ajax({type:"GET",dataType:"json",url:"universe.json",cache:false,xhr:function(){if(d.current.name=="dashboard.index"){$(".bar").show()}var h=new window.XMLHttpRequest();h.addEventListener("progress",function(l){if(l.lengthComputable){var m=l.loaded/l.total;$(".progress").animate({width:""+Math.round(m*100)+"%"},30);$(".value").html(Math.round(m*100)+"%")}else{$(".loading").fadeIn(150);$(".searchHistory").hide()}},false);return h},beforeSend:function(){},complete:function(){},success:function(l){var h=[];angular.forEach(l,function(m){if(m.symbol.toLowerCase()==i){h.push(m)}else{if(m.symbol.toLowerCase().toString()==i.toString()){h.push(m)}}return j.resolve(h)})}});return j.promise},getStock:function(g){var j=this;var i=b.defer();var h=g;if(Array.isArray(g)==false){g=[g]}f.post("../WebService/PortfolioWS.asmx/GetIESData",{symbols:g}).success(function(k){if(k.d.length>0){j.insertSearch(h)}a.IESdata=k.d;$(".loadingView").delay(400).fadeOut(150);return i.resolve(k.d)}).error(function(m,k,n,l){a.IESdata=[];$(".loadingView").delay(400).fadeOut(150);d.transitionTo("dashboard.noRes");return i.resolve([])});return i.promise},getStockHistory:function(g,i,j){var h=b.defer();f.post("../WebService/PortfolioWS.asmx/GetIESHistoryData",{symbol:g,startDate:i,optionSymbol:j}).success(function(k){$(".loadingView").delay(400).fadeOut(150);return h.resolve(k.d)}).error(function(m,k,n,l){a.IESdata=[];$(".loadingView").delay(400).fadeOut(150);d.transitionTo("dashboard.noRes");return h.resolve([])});return h.promise},insertSearch:function(i){if(i){if(typeof i!=="object"){i=[i]}i=i[0].toUpperCase();function k(o,m){var n={id:o,q:m};f.post("app/php/dashboardApi.php",{act:"newHistory",data:n}).success(function(r){if(r.length>0){var p=r.split(",");var q=[];angular.forEach(p,function(s){if(s.length>0){q.push({q:s})}});a.searchHistory=q;localStorage.setItem("searchHistory",r);a.sH=r}})}if(a.sH==null||a.sH=="null"){var h=i;k(a.userId,h)}else{var g=a.sH.split(",");if(g.indexOf(i)==-1){if(g.length==5||g.length>4){g.splice(4,1);g.unshift(i);g=g.toString();k(a.userId,g)}else{a.sH+=","+i;var h=a.sH;k(a.userId,h)}}else{var l=g.indexOf(i);var j=g.splice(l,1);g.unshift(i);g=g.toString();k(a.userId,g)}}}},clickHistory:function(h){h=h.toUpperCase();if(a.clickHistory!==null){var g=a.clickHistory;if(g[h]){g[h]++}else{g[h]=1}}else{var g={};g[h]=1}g=JSON.stringify(g);var i={id:a.userId,ch:g};f.post("app/php/dashboardApi.php",{act:"clickHistory",data:i}).success(function(j){localStorage.setItem("cH",JSON.stringify(j));a.clickHistory=JSON.parse(localStorage.cH)})},optWatchH:function(h){function j(m,k){k=JSON.stringify(k);var l={id:m,oW:k};f.post("app/php/dashboardApi.php",{act:"optWatchH",data:l}).success(function(n){localStorage.setItem("optionsWatch",JSON.stringify(n));a.optionsWatch=JSON.parse(localStorage.optionsWatch)})}var g=a.optionsWatch;if(g.optionsWatch.length!==0){var i=[];angular.forEach(g.optionsWatch,function(k){angular.forEach(k.pos,function(l){i.push(l.name)})});angular.forEach(g.optionsWatch,function(k){if(k.stock==h.stock){angular.forEach(k.pos,function(l){if(l.name==h.pos[0].name&&jQuery.inArray(h.pos[0].name,i)!==-1){l.views++;j(a.userId,g)}else{if(l.name!==h.pos[0].name&&jQuery.inArray(h.pos[0].name,i)==-1){i.push(h.pos[0].name);k.pos.push(h.pos[0]);j(a.userId,g)}}})}})}else{g.optionsWatch.push(h);j(a.userId,g)}},takePosition:function(i){var h=b.defer();var k=a.userId;var j=a.userPositions;var g={id:k,pos:j};g.pos.positions.push(i);f.post("app/php/dashboardApi.php",{act:"takePosition",data:g}).success(function(l){localStorage.setItem("uP",JSON.stringify(l));a.userPositions=JSON.parse(localStorage.uP);return h.resolve("OK")});return h.promise},deletePosition:function(i){var h=b.defer();var k=a.userId;var j=a.userPositions;var g={id:k,pos:j};angular.forEach(j.positions,function(m,l){if(i==m.stock){j.positions.splice(l,1);g.pos=j}});f.post("app/php/dashboardApi.php",{act:"takePosition",data:g}).success(function(l){f.post("../WebService/PortfolioWS.asmx/ClearIESPosition",{symbol:i}).success(function(m){console.log(m)}).error(function(o,m,p,n){a.IESdata=[];$(".loadingView").delay(400).fadeOut(150);d.transitionTo("dashboard.noRes");return h.resolve([])});localStorage.setItem("uP",JSON.stringify(l));a.userPositions=JSON.parse(localStorage.uP);return h.resolve("OK")});return h.promise},addToWL:function(g,k){var i=b.defer();if(a.watchlist==null||a.watchlist=="0"||a.watchlist=="null"){var j=g}else{var j=a.watchlist+=","+g}var h={id:k,wl:j};f.post("app/php/dashboardApi.php",{act:"addToWL",data:h}).success(function(l){localStorage.setItem("watchlist",l);a.watchlist=l;return i.resolve("OK")});return i.promise},removeWL:function(i){var h=b.defer();var g={id:a.userId,wl:i};f.post("app/php/dashboardApi.php",{act:"removeWL",data:g}).success(function(j){localStorage.setItem("watchlist",j);a.watchlist=i;return h.resolve("OK")});return h.promise}}}]);dashboardServices.factory("toolTip",["$rootScope",function(a){return{showContent:function(b){var c={marketCap:"This is a <b>content</b> string",originalScore:"This is yet another content string."};if(a.toolTipOn==true){return c[b]}}}}]);