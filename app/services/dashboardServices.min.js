var dashboardServices=angular.module("dashBoardServicesModule",[]);dashboardServices.run(["dashboardFactory","$state","$http","$q","$rootScope",function(g,f,h,d,b){if(!localStorage.userDefs){f.go("/")}else{var c=JSON.parse(localStorage.userDefs);b.ls=c;console.log(b.ls);b.username=c.username;b.userId=c.id;b.userPositions=JSON.parse(localStorage.uP);b.watchlist=localStorage.watchlist;b.sH=localStorage.searchHistory;b.clickHistory=JSON.parse(localStorage.cH);console.log(b.clickHistory);g.allStocks().then(function(i){b.allStocks=i});if(b.sH==undefined||b.sH==null){b.searchHistory=null}else{var a=b.sH.split(",");var e=[];angular.forEach(a,function(j){if(j.length>0){e.push({q:j})}});b.searchHistory=e}}h.get("/ies/universe.json").success(function(i){b.universe=i})}]);dashboardServices.factory("dashboardFactory",["$http","$q","$state","$rootScope","$timeout",function(e,b,d,a,c){return{loginUser:function(h,f){var g={username:h,password:f};e.post("app/php/dashboardApi.php",{act:"userLogin",data:g}).success(function(j){if(j=="NO_USER"){$("#warning").text("Wrong username")}else{if(j=="WRONG_PWD"){$("#warning").text("Wrong password")}else{if(j=="BLOCKED"){$("#warning").text("You were blocked out of the system.")}else{$("#warning").text("");localStorage.setItem("userDefs",JSON.stringify(j));localStorage.setItem("tracker",j.clickHistory);var i=JSON.parse(localStorage.userDefs);a.ls=i;a.username=i.username;a.userId=i.id;localStorage.watchlist=i.watchlist;a.watchlist=i.watchlist;localStorage.cH=i.clickHistory;a.clickHistory=JSON.parse(localStorage.cH);a.searchHistory=localStorage.searchHistory;localStorage.uP=i.positions;a.userPositions=JSON.parse(localStorage.uP);c(function(){d.go("dashboard")},300)}}}})},searchHistory:function(h){var g=b.defer();var f={id:h};e.post("app/php/dashboardApi.php",{act:"getHistory",data:f}).success(function(i){return g.resolve(i)});return g.promise},getStocks:function(g){var f={symbol:g};e.post("app/php/dashboardApi.php",{act:"getStocks",data:f}).success(function(h){})},allStocks:function(){var f=b.defer();e.get("/ies/universe.json").success(function(g){return f.resolve(g)});return f.promise},searchStock:function(g,j){var i=b.defer();g=g.toLowerCase();if(a.ls.searchHistory!==null&&a.ls.searchHistory!==""){var f=a.ls.searchHistory.toLowerCase()}if(g.length>2){}$.ajax({type:"GET",dataType:"json",url:"/ies/universe.json",cache:false,xhr:function(){if(d.current.name=="dashboard.index"){$(".bar").show()}var h=new window.XMLHttpRequest();h.addEventListener("progress",function(k){if(k.lengthComputable){var l=k.loaded/k.total;$(".progress").animate({width:""+Math.round(l*100)+"%"},30);$(".value").html(Math.round(l*100)+"%")}else{$(".loading").fadeIn(150);$(".searchHistory").hide()}},false);return h},beforeSend:function(){},complete:function(){},success:function(k){var h=[];angular.forEach(k,function(l){if(l.symbol.toLowerCase()==g){h.push(l)}else{if(l.symbol.toLowerCase().toString()==g.toString()){h.push(l)}}return i.resolve(h)})}});return i.promise},getStock:function(f){var g=b.defer();e.get("/ies/stockData.json").success(function(h){return g.resolve(h)});return g.promise},insertSearch:function(g){g=g.toUpperCase();if(a.sH==null){var f=g}else{if(a.sH.indexOf(1)==-1){a.sH+=","+g;var f=a.sH}}var h={id:a.userId,q:f};console.log(h);e.post("app/php/dashboardApi.php",{act:"newHistory",data:h}).success(function(k){if(k.length>0){var i=k.split(",");var j=[];angular.forEach(i,function(l){if(l.length>0){j.push({q:l})}});a.searchHistory=j;localStorage.setItem("searchHistory",k);a.sH=k}})},clickHistory:function(g){g=g.toUpperCase();if(a.clickHistory!==null){var f=a.clickHistory;if(f[g]){f[g]++}else{f[g]=1}}else{var f={};f[g]=1}f=JSON.stringify(f);var h={id:a.userId,ch:f};e.post("app/php/dashboardApi.php",{act:"clickHistory",data:h}).success(function(i){localStorage.setItem("cH",JSON.stringify(i));a.clickHistory=JSON.parse(localStorage.cH)})},takePosition:function(h){var g=b.defer();var j=a.userId;var i=a.userPositions;var f={id:j,pos:i};if(i.positions.length>0){angular.forEach(i.positions,function(k){if(h.stock==k.stock){k.position.push(h.position[0])}})}else{f.pos.positions.push(h)}e.post("app/php/dashboardApi.php",{act:"takePosition",data:f}).success(function(k){localStorage.setItem("uP",JSON.stringify(k));a.userPositions=JSON.parse(localStorage.uP);return g.resolve("OK")});return g.promise},addToWL:function(f,j){var h=b.defer();if(a.watchlist==null){var i=f}else{var i=a.watchlist+=","+f}var g={id:j,wl:i};console.log(g);e.post("app/php/dashboardApi.php",{act:"addToWL",data:g}).success(function(k){localStorage.setItem("watchlist",k);a.watchlist=k;return h.resolve("OK")});return h.promise}}}]);